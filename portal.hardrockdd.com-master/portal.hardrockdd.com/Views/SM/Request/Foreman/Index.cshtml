@model portal.Models.Views.SM.Request.ForemanDashboardViewModel
@{
    ViewBag.Title = "Shop Foreman Dashboard";
}

<link rel="stylesheet" href="https://cdn.datatables.net/1.10.24/css/dataTables.bootstrap4.min.css" />
<style>
    .priority-critical {
        background-color: #dc3545 !important;
        color: white;
    }

    .priority-high {
        background-color: #fd7e14 !important;
        color: white;
    }

    .priority-medium {
        background-color: #ffc107 !important;
    }

    .priority-low {
        background-color: #28a745 !important;
        color: white;
    }

    .stat-card {
        border-radius: 8px;
    }

    .emergency-row {
        background-color: #ffebee !important;
    }
</style>

<ol class="breadcrumb pull-right">
    <li class="breadcrumb-item"><a href="@Url.Action("Index", "Home", new { Area = "" })">Home</a></li>
    <li class="breadcrumb-item active">@ViewBag.Title</li>
</ol>
<h1 class="page-header">@ViewBag.Title</h1>

<!-- Summary Cards -->
<div class="row m-b-20">
    <div class="col-md-4">
        <div class="card stat-card bg-warning text-white">
            <div class="card-body text-center">
                <h5 class="card-title">Pending Review</h5>
                <h2>@Model.PendingCount</h2>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card stat-card bg-info text-white">
            <div class="card-body text-center">
                <h5 class="card-title">In Progress</h5>
                <h2>@Model.InProgressCount</h2>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card stat-card bg-success text-white">
            <div class="card-body text-center">
                <h5 class="card-title">Completed Today</h5>
                <h2>@Model.CompletedTodayCount</h2>
            </div>
        </div>
    </div>
</div>

<!-- Requests Table -->
<div class="panel panel-inverse">
    <div class="panel-heading">
        <h4 class="panel-title">Maintenance Requests</h4>
    </div>
    <div class="panel-body">
        @Html.AntiForgeryToken()
        <table class="table table-striped table-hover" id="requestsTable">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Equipment</th>
                    <th>Issue</th>
                    <th>Priority</th>
                    <th>Requested By</th>
                    <th>Status</th>
                    <th>Assigned To</th>
                    <th>Work Order</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model.Requests)
                {
                    var priorityClass = "priority-medium";
                    if (item.PriorityId == 4) { priorityClass = "priority-critical"; }
                    else if (item.PriorityId == 3) { priorityClass = "priority-high"; }
                    else if (item.PriorityId == 1) { priorityClass = "priority-low"; }

                    var rowClass = item.IsEmergency ? "emergency-row" : "";
                    <tr class="@rowClass">
                        <td data-order="@item.RequestDate.ToString("yyyy-MM-dd")">
                            @item.RequestDate.ToShortDateString()
                        </td>
                        <td>
                            <strong>@item.EquipmentId</strong><br />
                            <small class="text-muted">@item.EquipmentDescription</small>
                        </td>
                        <td>
                            @if (item.IsEmergency)
                            {
                                <span class="badge badge-danger">EMERGENCY</span><br />
                            }
                            @(item.Description != null && item.Description.Length > 50 ? item.Description.Substring(0, 50) + "..." : item.Description)
                        </td>
                        <td>
                            <span class="badge @priorityClass">@item.Priority</span>
                        </td>
                        <td>@item.RequestedBy</td>
                        <td>@item.Status</td>
                        <td>
                            @if (!string.IsNullOrEmpty(item.AssignedMechanicName))
                            {
                                <span class="text-success">@item.AssignedMechanicName</span>
                            }
                            else
                            {
                                <span class="text-muted">Unassigned</span>
                            }
                        </td>
                        <td>
                            @if (item.HasWorkOrder)
                            {
                                <a href="@Url.Action("Index", "EMWorkOrder", new { emco = item.EMCo, workOrderId = item.WorkOrderId })"
                                   class="btn btn-xs btn-info" target="_blank">
                                    @item.WorkOrderId
                                </a>
                            }
                        </td>
                        <td>
                            <a href="@Url.Action("ServiceRequestIndex", "ServiceRequest", new { smco = item.SMCo, requestId = item.RequestId })"
                               class="btn btn-xs btn-primary" title="View Request">
                                <i class="fa fa-eye"></i>
                            </a>
                            @if (item.HasWorkOrder)
                            {
                                <button type="button" class="btn btn-xs btn-success assign-mechanic"
                                        data-smco="@item.SMCo"
                                        data-requestid="@item.RequestId"
                                        data-lineid="@item.LineId"
                                        data-emco="@item.EMCo"
                                        data-workorderid="@item.WorkOrderId"
                                        data-equipment="@item.EquipmentId"
                                        title="Assign Mechanic">
                                    <i class="fa fa-user-plus"></i>
                                </button>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- Assign Mechanic Modal -->
<div class="modal fade" id="assignMechanicModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Assign Mechanic</h5>
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="assign_smco" />
                <input type="hidden" id="assign_requestid" />
                <input type="hidden" id="assign_lineid" />
                <input type="hidden" id="assign_emco" />
                <input type="hidden" id="assign_workorderid" />

                <p><strong>Equipment:</strong> <span id="assign_equipment"></span></p>

                <div class="form-group">
                    <label for="mechanicSelect">Select Mechanic</label>
                    <select id="mechanicSelect" class="form-control">
                        <option value="">-- Loading... --</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmAssign">Assign</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.10.24/js/dataTables.bootstrap4.min.js"></script>

<script>
    $(document).ready(function () {
        // Initialize DataTable with pagination
        var table = $('#requestsTable').DataTable({
            order: [[0, 'desc']],
            pageLength: 25,
            lengthMenu: [[10, 25, 50, 100], [10, 25, 50, 100]]
        });

        // Open assign modal
        $(document).on('click', '.assign-mechanic', function () {
            var btn = $(this);
            $('#assign_smco').val(btn.data('smco'));
            $('#assign_requestid').val(btn.data('requestid'));
            $('#assign_lineid').val(btn.data('lineid'));
            $('#assign_emco').val(btn.data('emco'));
            $('#assign_workorderid').val(btn.data('workorderid'));
            $('#assign_equipment').text(btn.data('equipment'));

            $('#mechanicSelect').html('<option value="">-- Loading... --</option>');
            $.get('@Url.Action("GetMechanics", "ServiceRequest")', { emco: btn.data('emco') }, function (data) {
                var select = $('#mechanicSelect');
                select.empty();
                select.append('<option value="">-- Select Mechanic --</option>');
                $.each(data, function (i, item) {
                    select.append('<option value="' + item.Value + '">' + item.Text + '</option>');
                });
            });

            $('#assignMechanicModal').modal('show');
        });

        // Confirm assignment
        $('#confirmAssign').click(function () {
            var mechanicId = $('#mechanicSelect').val();
            if (!mechanicId) {
                alert('Please select a mechanic');
                return;
            }

            $(this).prop('disabled', true).text('Assigning...');

            $.post('@Url.Action("AssignMechanic", "ServiceRequest")', {
                smco: $('#assign_smco').val(),
                requestId: $('#assign_requestid').val(),
                lineId: $('#assign_lineid').val(),
                emco: $('#assign_emco').val(),
                workOrderId: $('#assign_workorderid').val(),
                mechanicId: mechanicId,
                __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
            }, function (result) {
                if (result.success) {
                    $('#assignMechanicModal').modal('hide');
                    location.reload();
                } else {
                    alert('Error assigning mechanic');
                    $('#confirmAssign').prop('disabled', false).text('Assign');
                }
            }).fail(function() {
                alert('Error assigning mechanic');
                $('#confirmAssign').prop('disabled', false).text('Assign');
            });
        });
    });
</script>
