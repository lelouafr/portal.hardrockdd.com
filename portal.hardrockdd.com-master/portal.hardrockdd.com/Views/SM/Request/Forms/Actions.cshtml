@model portal.Models.Views.SM.Request.Forms.ActionViewModel
@{

    var viewOnly = bool.TryParse(ViewBag.ViewOnly?.ToString(), out bool viewOnlyOut) ? viewOnlyOut : false;
    var formLayout = new TableLayoutModel(this);
    var formId = "form_" + Guid.NewGuid();
    var btnId = "button_" + Model.RequestId.ToString();

}

<div class="row" id="@formId">
    <div class="col-lg-12 m-b-10">
        <div class="pull-right">
            @foreach (var action in Model.WorkFlowActions)
            {
                <button type="button" class="btn @action.ButtonClass @btnId" data-gotostatusid="@((int)action.GotoStatusId)" data-redirectaction="@action.ActionRedirect" data-actionurl="@action.ActionUrl" data-key="@formLayout.TableKey">@action.Title</button>
            }
        </div>
    </div>
</div>
<script>
    $('#@formId').ready(function () {
        $('#@(formId)').on('click', 'button.@btnId', function () {
            var button = $(this);
            $(button).SetButtonBusy();
            var gotoStatusId = $(this).data('gotostatusid');
            var redirectAction = $(this).data('redirectaction');
            var actionUrl = $(this).data('actionurl');
            var dst = $(document).find('.reviewPanel');

            // Use custom actionUrl if provided for CreateWorkOrder, otherwise default to RequestUpdateStatus
            var url = (actionUrl && actionUrl.includes("CreateWorkOrder")) ? actionUrl : "@Url.Action("RequestUpdateStatus", "ServiceRequest")";
            var token = $(document).find('[name="__RequestVerificationToken"]');

            // Parse the key data (e.g., "SMCo=1&RequestId=3195")
            var data = {};
            var keyString = $(this).data('key');
            if (keyString) {
                keyString.split('&').forEach(function(pair) {
                    var parts = pair.split('=');
                    if (parts.length === 2) {
                        data[parts[0]] = parts[1];
                    }
                });
            }

            data.gotoStatusId = gotoStatusId;
            data.redirectAction = redirectAction;
            data.__RequestVerificationToken = token.val();

            $.post(url, data, function (res) {
                $(button).SetButtonNotBusy();
                if (res.success === "true") {
                    if (actionUrl && actionUrl.includes("CreateWorkOrder") && res.url) {
                        // Redirect to the new work order
                        location.href = res.url;
                    }
                    else if ($(dst).length !== 0) {
                        $(dst).find('[data-click="panel-reload"]').click();
                    }
                    else {
                        location.href = res.url;
                    }
                }
                else {
                    // Show error if available
                    if (res.errorModel) {
                        alert('Error: ' + JSON.stringify(res.errorModel));
                    }
                }
            });
        });
    });
</script>