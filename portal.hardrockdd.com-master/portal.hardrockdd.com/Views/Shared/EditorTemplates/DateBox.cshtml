@model DateTime?

@{
    var id = Html.IdFor(m => m).ToString();
    if (id.LastIndexOf("_") > 0)
    {
        id = id.Substring(id.LastIndexOf("_") + 1);
    }
    var idGuid = "group_" + Guid.NewGuid();
    var name = id;
    id = string.Concat(id, idGuid);

    var viewOnly = bool.TryParse(ViewBag.ViewOnly?.ToString(), out bool viewOnlyOut) ? viewOnlyOut : false;
    viewOnly = this.ViewData.ModelMetadata.IsReadOnly ? true : viewOnly;
    var prop = this.ViewData.ModelMetadata.PropertyName;
    var displayOnly = bool.TryParse(ViewBag.DisplayOnly?.ToString(), out bool displayOnlyOut) ? displayOnlyOut : false;
    var tableRow = bool.TryParse(ViewBag.TableRow?.ToString(), out bool tableRowOut) ? tableRowOut : false;
    var attributes = this.ViewData.ModelMetadata.AdditionalValues.TryGetValue("FieldAttribute", out object fldAttribute) ?
                            (FieldAttribute)fldAttribute :
                            new FieldAttribute();

    /**Define Html Attributes**/
    var dic = new Dictionary<string, object>();
    dic.Add("data-updrelatedpanes", attributes.UpdateRelatedPanes);
    dic.Add("id", id);
    dic.Add("Name", name);
    if (this.ViewData.ModelMetadata.IsRequired)
    {
        dic.Add("required", "");
    }
    if (viewOnly)
    {
        dic.Add("disabled", "");
    }

    //autocomplete="false"
    dic.Add("autocomplete", "off");
    dic.Add("placeholder", "##/##/####");
    dic.Add("data-datepickerid", idGuid);
    if (ViewBag.StartDate != null)
    {
        var startDate = DateTime.TryParse(ViewBag.StartDate.ToString(), out DateTime dateTimeout) ? dateTimeout : DateTime.Now;
        dic.Add("data-date-start-date", startDate.ToString("MM/dd/yyyy"));
    }
    if (ViewBag.EndDate != null)
    {
        var endDate = DateTime.TryParse(ViewBag.EndDate.ToString(), out DateTime dateTimeout) ? dateTimeout : DateTime.Now;
        dic.Add("data-date-end-date", endDate.ToString("MM/dd/yyyy"));
    }

    if (!string.IsNullOrEmpty(attributes.ComboUrl))
    {
        dic.Add("data-combourl", attributes.ComboUrl);
        dic.Add("data-combokeys", attributes.ComboForeignKeys);
    }

    var labelSize = "col-lg-" + @attributes.LabelSize.ToString();
    var textSize = "";
    if (!tableRow)
        textSize = "col-lg-" + @attributes.TextSize.ToString();
}

@if (attributes.LabelSize != 0 && !tableRow)
{
    @Html.LabelForRequired(m => m, new { @class = @labelSize + " col-form-label text-lg-right col-form-label" })
}
@if (displayOnly)
{
<span Name="@name">
    @if (@Model != null)
    {
        @Model.Value.ToShortDateString()
    }
</span>
}
else
{
    <div class="@textSize input-group " id="@idGuid">
        @Html.TextBoxFor(m => m, "{0:MM/dd/yyyy}", StaticFunctions.GetHtmlAttributes(new { @class = ("form-control text-right " + prop) }, dic))
        @if (!string.IsNullOrEmpty(attributes.InfoUrl))
        {
            <div class="input-group-append">
                <button type="button" class="btn btn-primary btnInfo" data-urlinfo="@ViewBag.InfoUrl" data-infodata="@ViewBag.InfoData">
                    <i class="fas fa-info"></i>
                </button>
            </div>
        }
        @Html.ValidationMessageFor(m => m, "", new { @class = "invalid-feedback" })
    </div>
}


<!--<script>
    $(function () {
        //console.log('date picker value', $('[data-datepickerid=@idGuid]').val());
            datepicker_options = {
                altFormat: "mm/dd/yyyy",
                dateFormat: "mm/dd/yy",
                yearRange: "1000:3000",
                orientation: 'bottom',
                changeMonth: true,
                changeYear: true,
                todayHighlight: true,
            };
            $('[data-datepickerid=@idGuid]').datepicker(datepicker_options);-->
            @*$('[data-datepickerid=@idGuid]').datepicker(datepicker_options).on('change', function () {
                $('.datepicker').hide();
                date = $(this).datepicker('getDate');
                //dateISO = date.toISOString();
                //console.log('datechanged', date, dateISO, date.getTimezoneOffset());
                date.setMinutes(date.getMinutes() - date.getTimezoneOffset());
                //console.log('datechanged fix', date);

            });*@
        <!--});
</script>-->
